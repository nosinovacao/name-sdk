version: '2.1'

services:
  integration-tester:
    build: ./NAME.IntegrationTests
    links:
      - mongo
      - rabbitmq
      - sqlserver
      - specific-mongo
      - specific-rabbitmq
      - dummy-service
      - elasticsearch
      - specific-elasticsearch
      - dummy-console-kestrel
    environment:
      - LATEST_MONGO_HOSTNAME=mongo
      - LATEST_RABBIT_HOSTNAME=rabbitmq
      - LATEST_SQLSERVER_HOSTNAME=sqlserver
      - SPECIFIC_MONGO_HOSTNAME=specific-mongo
      - SPECIFIC_MONGO_VERSION=3.0.15
      - SPECIFIC_RABBIT_HOSTNAME=specific-rabbitmq
      - SPECIFIC_RABBIT_VERSION=3.6.5
      - SPECIFIC_SERVICE_HOSTNAME=dummy-service
      - SPECIFIC_SERVICE_VERSION=1.0.0
      - SPECIFIC_KESTREL_SELFHOST_HOSTNAME=dummy-console-kestrel
      - SPECIFIC_KESTREL_SELFHOST_VERSION=1.0.0
      - OPERATING_SYSTEM=debian
      - RUNNING_ON_DOCKER=true
      - LATEST_ELASTICSEARCH_HOSTNAME=elasticsearch
      - SPECIFIC_ELASTICSEARCH_HOSTNAME=specific-elasticsearch
      - SPECIFIC_ELASTICSEARCH_VERSION=5.5.1
    volumes:
      - ../Output/Artifacts/NuGets/Release:/integration/nugets
      - ../Output/IntegrationTestsResults:/integration/TestResults
    depends_on:
      - mongo
      - rabbitmq
      - sqlserver
      - specific-mongo
      - specific-rabbitmq
      - dummy-service
      - elasticsearch
      - specific-elasticsearch
      - dummy-console-kestrel
    networks:
      - integration-tests-network

  dummy-service:
    build: ./NAME.DummyService
    environment:
      - RUNNING_ON_DOCKER=true
    volumes:
      - ../Output/Artifacts/NuGets/Release:/service/nugets
    expose:
      - "5000"
    networks:
      - integration-tests-network

  dummy-console-kestrel:
    build: ./NAME.DummyConsole.Kestrel
    environment:
      - RUNNING_ON_DOCKER=true
    volumes:
      - ../Output/Artifacts/NuGets/Release:/service/nugets
    expose:
      - "40500"
    networks:
      - integration-tests-network

  mongo:
    image: mongo
    expose:
      - "27017"
    networks:
      - integration-tests-network

  specific-mongo:
    image: mongo:3.0.15
    expose:
      - "27017"
    networks:
      - integration-tests-network

  rabbitmq:
    image: rabbitmq
    expose:
      - "5672"
    networks:
      - integration-tests-network

  specific-rabbitmq:
    image: rabbitmq:3.6.5
    expose:
      - "5672"
    networks:
      - integration-tests-network

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2017-latest-ubuntu
    expose:
      - "1433"
    environment:
      - SA_PASSWORD=W1#llnotbeused
      - ACCEPT_EULA=Y
    networks:
      - integration-tests-network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:5.6.3
    expose:
      - "9200"
    environment:
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    networks:
      - integration-tests-network

  specific-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:5.5.1
    expose:
      - "9200"
    environment:
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    networks:
      - integration-tests-network

networks:
  integration-tests-network:
